# 🚀 快速开始指南

## 📋 前置要求

1. **Visual Studio 已安装**（需要 C++ 编译器）
2. **SQLite 文件已准备**：
   - ✅ `lib\sqlitex64\sqlite3.c`
   - ✅ `lib\sqlitex64\sqlite3.h`
   - ✅ `lib\sqlitex64\sqlite3.dll`

---

## 🔨 编译方法

### 方法一：使用 nmake（推荐）

1. **打开 Visual Studio Developer Command Prompt**
   - 开始菜单 → Visual Studio 2022 → Developer Command Prompt for VS 2022

2. **编译项目**
   ```cmd
   cd "e:\大学有关文件\计算机网络\LabGit\Lab1"
   nmake clean
   nmake
   ```

3. **检查编译结果**
   ```cmd
   dir build\*.exe
   
   # 应该看到：
   # Client.exe
   # Server.exe
   ```

### 方法二：使用编译脚本

1. **打开 Visual Studio Developer Command Prompt**

2. **运行编译脚本**
   ```cmd
   cd "e:\大学有关文件\计算机网络\LabGit\Lab1"
   compile.bat
   ```

3. **等待编译完成**（约 10-30 秒）

---

## 🎮 运行测试

### 测试场景 1：首次使用

**步骤：**

1. **启动服务器**
   ```cmd
   build\Server.exe
   ```
   看到：`Server is listening on port 8888...`

2. **启动客户端 1（Alice）**
   ```cmd
   build\Client.exe
   ```
   
   ```
   请输入昵称: Alice
   
   [Storage] 数据库已打开: data\Alice_chat.db
   [Storage] 数据库表初始化完成
   [SYS] ✅ 数据库已加载
   [SYS] 这是你首次使用，开始新的聊天吧！
   
   Alice [未加入]: /join ALL
   [系统] 已加入会话 ALL
   
   Alice [ALL]: 大家好！
   [Alice] 大家好！
   ```

3. **启动客户端 2（Bob）**
   ```cmd
   build\Client.exe
   ```
   
   ```
   请输入昵称: Bob
   
   [SYS] ✅ 数据库已加载
   [SYS] 这是你首次使用，开始新的聊天吧！
   
   Bob [未加入]: /join ALL
   [系统] 已加入会话 ALL
   [系统] Alice 加入了会话
   
   [Alice] 大家好！  （看到 Alice 之前发的消息）
   
   Bob [ALL]: 你好 Alice！
   [Bob] 你好 Alice！
   ```

4. **退出客户端**
   ```
   Alice [ALL]: /exit
   ```

### 测试场景 2：历史恢复

1. **Alice 重新登录**
   ```cmd
   build\Client.exe
   ```
   
   ```
   请输入昵称: Alice
   
   [SYS] ✅ 数据库已加载
   [SYS] 找到 1 个历史会话：
     - ALL [群聊] (2 条历史)
   [提示] 使用 /switch <会话名> 切换到历史会话
   
   Alice [未加入]: /switch ALL
   [Client] 已切换到会话: ALL
   --- 最近消息 ---
   [Alice] 大家好！
   [Bob] 你好 Alice！
   ---------------
   
   Alice [ALL]: /history
   
   ========== ALL 聊天记录 ==========
   （共 2 条）
   -------------------------------------------
   [Alice] 大家好！
   [Bob] 你好 Alice！
   ==========================================
   ```

### 测试场景 3：私聊持久化

1. **Alice 发起私聊**
   ```
   Alice [ALL]: /join Bob
   [系统] 已加入会话 Bob
   
   Alice [Bob]: 你好 Bob，私聊测试
   [Alice] 你好 Bob，私聊测试
   ```

2. **Bob 收到私聊**
   ```
   Bob [ALL]: 
   [新消息 @Alice] Alice: 你好 Bob，私聊测试
   
   Bob [ALL]: /join Alice
   [系统] 已加入会话 Alice
   
   Bob [Alice]: 你好 Alice！
   ```

3. **Alice 退出并重新登录**
   ```
   Alice [Bob]: /exit
   
   # --- 重新登录 ---
   
   请输入昵称: Alice
   
   [SYS] 找到 2 个历史会话：
     - Bob [私聊] (2 条历史)
     - ALL [群聊] (2 条历史)
   ```

---

## 🎯 可用命令

| 命令 | 功能 | 示例 |
|------|------|------|
| `/join <会话名>` | 加入会话 | `/join ALL`<br>`/join Bob` |
| `/leave <会话名>` | 离开会话 | `/leave ALL` |
| `/switch <会话名>` | 切换会话 | `/switch Bob` |
| `/sessions` | 显示所有会话 | `/sessions` |
| `/history` | 查看当前会话历史 | `/history` |
| `/exit` | 退出程序 | `/exit` |

---

## 📁 数据库文件位置

编译运行后，会自动创建：

```
Lab1/
└── data/
    ├── Alice_chat.db    # Alice 的聊天记录
    └── Bob_chat.db      # Bob 的聊天记录
```

### 查看数据库内容

**使用 SQLite 命令行工具：**

```cmd
# 下载 sqlite3.exe 并放到 PATH 中
# 或使用：lib\sqlitex64\sqlite3.exe（如果你下载了完整包）

sqlite3 data\Alice_chat.db

sqlite> .tables
messages  sessions

sqlite> SELECT * FROM messages;
# 显示所有消息记录

sqlite> SELECT session_id, COUNT(*) as count FROM messages GROUP BY session_id;
# 统计每个会话的消息数量

sqlite> .quit
```

---

## 🐛 常见问题

### 问题 1：编译时提示找不到标准库

**错误：**
```
fatal error C1083: 无法打开包括文件: "iostream"
```

**解决：**
必须在 **Visual Studio Developer Command Prompt** 中运行编译命令，不能在普通 cmd 中。

### 问题 2：运行时找不到 sqlite3.dll

**错误：**
```
无法启动此程序，因为计算机中丢失 sqlite3.dll
```

**解决：**
```cmd
copy lib\sqlitex64\sqlite3.dll build\
```

### 问题 3：数据库初始化失败

**错误：**
```
[Storage] 无法打开数据库
```

**解决：**
```cmd
mkdir data
```

### 问题 4：服务器无法启动

**错误：**
```
bind failed
```

**解决：**
- 端口 8888 被占用，关闭其他程序或修改端口
- 或者以管理员权限运行

---

## 📊 性能测试

### 测试消息持久化性能

```cmd
# 在 Alice 客户端
Alice [ALL]: /join ALL

# 发送 100 条消息（可以写个循环脚本）
# 然后退出重新登录

Alice [未加入]: /sessions
# 查看消息数量

Alice [未加入]: /switch ALL
Alice [ALL]: /history
# 查看所有历史记录是否完整
```

### 测试多客户端并发

1. 同时运行 3-5 个客户端
2. 都加入 ALL 群聊
3. 同时发送消息
4. 检查每个客户端的数据库是否正确保存

---

## ✅ 验证清单

### 编译验证
- [ ] `build\Server.exe` 存在
- [ ] `build\Client.exe` 存在
- [ ] `build\Storage.obj` 存在
- [ ] `build\sqlite3.obj` 存在

### 功能验证
- [ ] Server 能正常启动并监听 8888 端口
- [ ] Client 能连接到 Server
- [ ] 首次登录创建数据库文件（`data\{用户名}_chat.db`）
- [ ] 发送消息后数据库中有记录
- [ ] 退出后重新登录能看到历史会话
- [ ] `/history` 命令能显示完整历史
- [ ] `/sessions` 命令显示所有会话
- [ ] 私聊功能正常（`/join <用户名>`）
- [ ] 会话切换正常（`/switch <会话名>`）

### 数据持久化验证
- [ ] 每条发送的消息都保存到数据库
- [ ] 每条接收的消息都保存到数据库
- [ ] 新会话自动保存到 sessions 表
- [ ] 时间戳正确记录
- [ ] 会话类型正确（GROUP / PRIVATE）

---

## 🎉 成功标志

如果看到以下输出，说明集成成功：

```
请输入昵称: Alice

[Storage] 数据库已打开: data\Alice_chat.db
[Storage] 数据库表初始化完成
[SYS] ✅ 数据库已加载
```

并且退出后重新登录能看到：

```
[SYS] 找到 X 个历史会话：
  - ALL [群聊] (XX 条历史)
  - Bob [私聊] (XX 条历史)
```

恭喜你！消息持久化功能已成功集成！🎊
