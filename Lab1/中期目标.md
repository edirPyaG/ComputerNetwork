# 📘 项目阶段目标：Session 统一管理与消息持久化

## 🎯 一、项目阶段目标总览

在保持现有 **C/C++ 多线程聊天系统** 稳定运行的基础上：

- **重构核心逻辑**：所有会话（群聊、私聊）统一抽象为 `Session`
- **实现消息持久化**：聊天数据通过 **SQLite** 数据库保存

完成后，系统将从命令行聊天室升级为具备可扩展架构的小型即时通信内核。

---

## 🧩 二、功能目标细化

### 1️⃣ Session 统一管理

> 无论是私聊还是群聊，都用同一种 `Session` 数据结构、同一张路由表管理。
> Session 由 `id` 唯一标识，私聊时为对方用户名，群聊时为群名。

#### 实现要点

| 子项                     | 说明                                                                                     |
| ------------------------ | ---------------------------------------------------------------------------------------- |
| **统一数据结构**   | `Session { id, type, set<members> }`；所有会话都在一张 `map<string, Session>` 中管理 |
| **协议统一**       | 协议格式：`TYPE                                                                          |
| **服务端路由逻辑** | 查 `session.id → members`，遍历广播消息；私聊是仅两人的 session                       |
| **客户端管理**     | 本地 `sessions[session_id] -> ChatSession`，`current_session` 表示当前聊天窗口       |
| **命令支持**       | `/switch <user/group>` 切换会话；`/join <group>` 创建或加入群                        |
| **线程安全**       | 使用 `std::mutex` 保护 `sessions` 与成员表并发访问                                   |

**完成效果：**

- 群聊、私聊逻辑完全统一；
- 客户端与服务端结构一致；
- 后续可直接接入数据库或 GUI，无需重构。

---

### 2️⃣ 消息持久化（SQLite）

> 每条消息都在本地 **SQLite** 数据库中永久保存，按 Session 维度存储。
> 程序关闭后仍可读取历史聊天记录。

#### 实现要点

| 子项                 | 说明                                                                            |
| -------------------- | ------------------------------------------------------------------------------- |
| **数据库设计** | 表结构：`chat(id, session_id, session_type, sender, receiver, message, time)` |
| **初始化**     | 程序启动时建表，退出时关闭连接                                                  |
| **写入操作**   | 在消息发送/接收处调用 `save_message()` 即时落盘                               |
| **读取逻辑**   | 支持 `SELECT * FROM chat WHERE session_id=? ORDER BY time`                    |
| **线程安全**   | 多线程写入时加锁或使用 SQLite 串行化模式                                        |

**完成效果：**

- 支持断点恢复与历史查询；
- 数据结构与 Session 直接对应；
- 未来 GUI 可直接从数据库加载对话历史。

---

## 🧠 三、工程与展示意义

| 层级 | 改进效果                               |
| ---- | -------------------------------------- |
| 架构 | Session 统一抽象 → 逻辑纯粹、维护简洁 |
| 网络 | 消息路由统一 → 服务器转发更高效       |
| 数据 | SQLite 持久化 → 聊天数据安全可分析    |
| 展示 | GUI 可直接映射 Session 列表和历史记录  |

---

## 🕓 四、阶段产出与检查点

| 阶段                   | 关键产物                                                  |
| ---------------------- | --------------------------------------------------------- |
| **核心重构完成** | `session` 管理容器，统一路由逻辑                        |
| **功能联调**     | 私聊、群聊皆能在统一模型下通信                            |
| **持久化接入**   | C++ 函数 `init_database()`、`save_message()` 稳定写入 |
| **验证**         | 程序重启后 SQLite 中历史可查询                            |
| **报告**         | Session 结构图、时序图、数据库表结构设计                  |

---

## ✅ 五、阶段目标总结

- **核心目标**：让系统“理解”聊天本质——操作的是 *Session* ；
- **数据目标**：让每条消息成为一条可长期保存的数据库记录。

实现这两项后，系统具备完整的可扩展内核。
任何后续强化——GUI、统计分析、文件传输——都能自然叠加在 Session 与 SQLite 之上。
