# 📅 时间戳智能显示功能说明

## ✅ 实现完成

已成功实现类似微信的智能时间戳显示功能！

---

## 🎯 功能特性

### 1️⃣ 智能显示规则
- ⏰ **时间间隔 < 5分钟**：不显示时间戳（连续聊天）
- ⏰ **时间间隔 ≥ 5分钟**：显示时间戳分隔线

### 2️⃣ 时间格式化（类似微信）
| 时间范围 | 显示格式 | 示例 |
|---------|---------|------|
| 今天 | `HH:MM` | `14:30` |
| 昨天 | `昨天 HH:MM` | `昨天 09:15` |
| 本周 | `周X HH:MM` | `周三 20:45` |
| 今年 | `MM-DD HH:MM` | `11-12 16:20` |
| 跨年 | `YYYY-MM-DD HH:MM` | `2024-11-14 10:00` |

### 3️⃣ 显示效果示例

```
--- 14:30 ---
[Alice] 大家好
[Bob] 你好！
[Charlie] 欢迎

（5分钟后...）

--- 14:36 ---
[Alice] 刚才说到哪了？
[Bob] 我们在讨论项目
```

---

## 🔧 技术实现

### 修改内容

#### 1. Message 结构体增强
```cpp
struct Message {
    std::string type;
    std::string sender;
    std::string accepter;
    std::string content;
    int64_t timestamp;  // 🔥 新增：Unix时间戳（秒）
};
```

#### 2. 协议格式更新
```
旧格式: TYPE|SENDER|ACCEPTER|CONTENT
新格式: TYPE|SENDER|ACCEPTER|CONTENT|TIMESTAMP
```

#### 3. 核心函数

##### `formatTimestamp(int64_t timestamp)`
- 功能：将时间戳格式化为易读字符串
- 智能判断：今天/昨天/本周/今年/跨年

##### `shouldShowTimestamp(currentTime, lastTime, threshold)`
- 功能：判断是否需要显示时间戳
- 阈值：默认 300 秒（5分钟）
- 规则：首条消息或间隔超过阈值则显示

---

## 📍 显示位置

### ✅ 实时消息接收
在 `recvThread()` 中接收到消息时：
```cpp
if (shouldShowTimestamp(m.timestamp, lastMsgTime, 300)) {
    std::cout << "\n--- " << formatTimestamp(m.timestamp) << " ---" << std::endl;
}
std::cout << "[" << m.sender << "] " << m.content << std::endl;
```

### ✅ 切换会话（/switch）
显示最近 5 条消息时自动插入时间戳

### ✅ 查看历史（/history）
从数据库加载历史记录时自动插入时间戳

---

## 🎨 自定义配置

### 修改时间间隔阈值

在 `Client.cpp` 中搜索 `shouldShowTimestamp`，修改第三个参数：

```cpp
// 默认 5 分钟 (300 秒)
shouldShowTimestamp(m.timestamp, lastTime, 300)

// 改为 3 分钟
shouldShowTimestamp(m.timestamp, lastTime, 180)

// 改为 10 分钟
shouldShowTimestamp(m.timestamp, lastTime, 600)
```

### 修改时间格式

在 `Client.cpp` 的 `formatTimestamp()` 函数中修改 `strftime()` 格式字符串：

```cpp
// 今天显示格式
strftime(buffer, sizeof(buffer), "%H:%M", timeInfo);

// 改为 12 小时制
strftime(buffer, sizeof(buffer), "%I:%M %p", timeInfo);  // 输出：02:30 PM
```

---

## 🧪 测试建议

### 测试场景 1：连续聊天
1. 快速发送多条消息（< 5分钟）
2. **预期**：只在第一条显示时间戳

### 测试场景 2：间隔聊天
1. 发送一条消息
2. 等待 6 分钟
3. 再发送一条消息
4. **预期**：两条消息都有时间戳

### 测试场景 3：历史记录
1. `/history` 查看聊天历史
2. **预期**：自动在合适位置插入时间戳分隔线

### 测试场景 4：跨天消息
1. 查看昨天的聊天记录
2. **预期**：显示"昨天 HH:MM"

---

## 🔍 数据库支持

### 时间戳存储
- 字段：`messages.timestamp`
- 类型：`INTEGER`（Unix时间戳）
- 自动：消息保存时自动记录当前时间

### 查询优化
已添加索引：
```sql
CREATE INDEX idx_session_time ON messages(session_id, timestamp);
```

---

## 💡 未来扩展

### 可能的增强功能
1. ⏰ 支持时区转换
2. 📅 显示"刚刚"、"1小时前"等相对时间
3. 🎨 自定义时间戳样式（颜色、边框）
4. 🌐 国际化支持（英文/中文切换）
5. 📊 显示消息统计（今天发送了多少条）

---

## 📚 相关文件

| 文件 | 修改内容 |
|------|---------|
| `include/Common.h` | Message 结构体新增 timestamp |
| `src/Common.cpp` | parseMessage/buildMessage 支持时间戳 |
| `include/Client.h` | 新增时间戳函数声明 |
| `src/Client.cpp` | 实现格式化和显示逻辑 |
| `src/Storage.cpp` | 查询时读取 timestamp 字段 |

---

## ✅ 功能检查清单

- [x] Message 结构体包含 timestamp
- [x] 协议支持时间戳传输
- [x] 格式化函数实现（今天/昨天/本周/今年/跨年）
- [x] 智能判断函数实现（可配置阈值）
- [x] 实时消息显示时间戳
- [x] 切换会话显示时间戳
- [x] 历史记录显示时间戳
- [x] 数据库查询恢复时间戳
- [x] 兼容旧消息（无时间戳时使用当前时间）

---

## 🎉 总结

现在你的聊天系统具备了完整的时间戳功能！
- 自动智能显示
- 格式友好易读
- 支持历史回溯
- 数据库持久化

体验效果类似微信，用户体验大幅提升！ 🚀
