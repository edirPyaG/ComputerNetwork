# 微信式聊天系统测试指南

## 🎯 核心改进

本次重构实现了类似微信的会话管理机制：

1. ✅ **用户上线不自动加入任何会话**
2. ✅ **必须主动 `/join` 才能加入会话**
3. ✅ **消息只在已加入的会话中发送/接收**
4. ✅ **支持群聊和私聊会话切换**
5. ✅ **私聊时对方自动加入会话**

---

## 📋 新增命令

| 命令 | 说明 | 示例 |
|------|------|------|
| `/join <会话名>` | 加入会话 | `/join ALL` 或 `/join Bob` |
| `/leave <会话名>` | 离开会话 | `/leave ALL` |
| `/switch <会话名>` | 切换当前会话 | `/switch Bob` |
| `/sessions` | 显示所有已加入的会话 | `/sessions` |
| `/exit` | 退出程序 | `/exit` |

---

## 🧪 测试场景

### **场景 1：基本群聊流程**

#### 步骤 1：启动服务器
```bash
cd e:\大学有关文件\计算机网络\LabGit\Lab1
nmake
Server.exe
```

**预期输出：**
```
Server is listening on port 8888...
Waiting for client connection...
```

#### 步骤 2：启动客户端 A（Alice）
```bash
Client.exe
请输入昵称: Alice
```

**预期输出：**
```
[提示] 请使用 /join <会话名> 加入会话
[提示] 例如：/join ALL 加入聊天室

Alice [未加入]:
```

**服务器输出：**
```
[SYS] User Alice connected (not joined any session)
[SYS] Created default group session: ALL
```

#### 步骤 3：Alice 尝试直接发消息（应该失败）
```
Alice [未加入]: Hello
```

**预期输出：**
```
[错误] 请先加入一个会话，例如：/join ALL
```

#### 步骤 4：Alice 加入 ALL 群
```
Alice [未加入]: /join ALL
```

**预期输出（Client）：**
```
[Client] 正在加入会话: ALL
Alice [ALL]:
```

**服务器输出：**
```
[SYS] Alice trying to join session: ALL
[SYS] Alice joined session ALL
```

#### 步骤 5：启动客户端 B（Bob）并加入群聊
```bash
Client.exe
请输入昵称: Bob
Bob [未加入]: /join ALL
```

**预期输出（Bob）：**
```
[系统] 已加入会话 ALL
Bob [ALL]:
```

**预期输出（Alice 看到）：**
```
[系统] Bob 加入了会话
```

#### 步骤 6：群聊测试
```
Alice [ALL]: Hello everyone!
```

**预期输出（Bob 看到）：**
```
[Alice] Hello everyone!
```

**预期输出（Alice 看到回显）：**
```
[Alice] Hello everyone!
```

---

### **场景 2：私聊流程**

#### 步骤 1：Alice 切换到私聊（但还未加入）
```
Alice [ALL]: /switch Bob
```

**预期输出：**
```
[错误] 你还没有加入会话 Bob
[提示] 请先 /join Bob
```

#### 步骤 2：Alice 加入私聊会话
```
Alice [ALL]: /join Bob
```

**预期输出：**
```
[Client] 正在加入会话: Bob
Alice [Bob]:
```

**服务器输出：**
```
[SYS] Alice trying to join session: Bob
[WARN] Session Bob not found
```

**注意：** 服务器会提示 session 不存在，因为私聊 session 需要通过发送消息创建。

#### 步骤 3：Alice 发私聊消息
```
Alice [Bob]: Hi Bob, this is private
```

**这时会失败，因为 Bob session 不存在。正确流程应该是：**

**正确的私聊流程：**
```
Alice [ALL]: /switch Bob     # 本地切换（创建本地 session）
Alice [Bob]: Hi Bob          # 发送失败（服务器 session 不存在）
```

**更好的设计：** 让服务器在收到私聊消息时自动创建 session。

---

### **场景 3：查看会话列表**

```
Alice [ALL]: /sessions
```

**预期输出：**
```
=== 我的会话列表 ===
ALL [群聊] - 3 条消息 [当前]
Bob [私聊] - 1 条消息
===================
```

---

### **场景 4：会话切换**

```
Alice [ALL]: /switch Bob
```

**预期输出：**
```
[Client] 已切换到会话: Bob
--- 最近消息 ---
[Alice] Hi Bob
---------------
Alice [Bob]:
```

---

### **场景 5：离开会话**

```
Alice [ALL]: /leave ALL
```

**预期输出：**
```
[Client] 正在离开会话: ALL
[系统] 已离开会话 ALL
Alice [未加入]:
```

---

## ⚠️ 当前已知问题

### **问题 1：私聊 session 创建逻辑**

**现象：** 
- 用户 A `/join Bob` 失败，因为 Bob session 不存在
- 需要先发消息才能创建私聊 session

**原因：**
- `onJoinSession` 检查 session 是否存在，不存在则返回错误
- 私聊 session 应该在 `/join` 时自动创建

**修复建议：**
在 `onJoinSession` 中添加：
```cpp
// 如果是私聊且 session 不存在，自动创建
if (it == sessions.end() && sessionId != "ALL") {
    // 假设 sessionId 是对方用户名，创建私聊 session
    createPrivateSession(userName, sessionId);
    it = sessions.find(sessionId);  // 重新查找
}
```

### **问题 2：私聊 sessionId 命名不一致**

**现象：**
- 客户端以对方用户名作为 sessionId（如 "Bob"）
- 服务器创建的私聊 session ID 是 "Alice_Bob"（字典序）

**原因：**
- 两端命名规则不一致

**修复建议：**
统一使用对方用户名作为 sessionId（更符合微信逻辑）

---

## 🔧 编译和运行

```bash
# 清理旧文件
nmake clean

# 编译
nmake

# 启动服务器
Server.exe

# 启动客户端（开多个终端）
Client.exe
```

---

## 📊 测试检查表

- [ ] 用户上线不自动加入 ALL 群
- [ ] 未加入会话时不能发消息
- [ ] `/join ALL` 可以加入群聊
- [ ] 群聊消息能正常收发
- [ ] `/sessions` 显示会话列表
- [ ] `/switch` 切换会话
- [ ] `/leave` 离开会话
- [ ] 私聊消息创建 session
- [ ] 私聊对方收到通知
- [ ] `/exit` 正常退出

---

## 🎉 成功标志

当你看到以下流程顺利完成，说明系统正常工作：

1. Alice 连接 → 看到"请使用 /join ALL 加入聊天室"
2. Alice `/join ALL` → 成功加入
3. Bob 连接并 `/join ALL` → Alice 看到 "Bob 加入了会话"
4. Alice 和 Bob 在 ALL 中聊天 → 互相看到消息
5. Alice `/switch Bob` 并发消息 → 私聊成功
6. Bob 收到通知并切换 → 可以回复

这样就实现了真正的微信式会话管理！
