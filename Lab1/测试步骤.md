# 🧪 详细测试步骤

## 📝 修复内容总结

### 已修复的问题：
1. ✅ `/join ALL` 命令解析 - 修复了空格处理问题
2. ✅ 私聊 session 自动创建 - 服务器在用户 `/join <用户名>` 时自动创建私聊 session
3. ✅ 命令参数提取 - 统一使用空格分割，支持前后有空格
4. ✅ 添加调试输出

---

## 🔧 编译步骤

```bash
cd e:\大学有关文件\计算机网络\LabGit\Lab1
nmake clean
nmake
```

如果编译出错，检查：
- `std::max` 问题：可能需要 `#include <algorithm>`
- 如果还有问题，将 `std::max(0, (int)history.size() - 5)` 改为三元运算符

---

## 📋 测试场景 1：基本群聊

### 步骤 1：启动服务器
```bash
Server.exe
```

**预期输出：**
```
Server is listening on port 8888...
```

### 步骤 2：启动客户端 J
```bash
Client.exe
请输入昵称: J
```

**预期输出：**
```
[提示] 请使用 /join <会话名> 加入会话
[提示] 例如：/join ALL 加入聊天室

J [未加入]:
```

**服务器输出：**
```
[SYS] User J connected (not joined any session)
[SYS] Created default group session: ALL
```

### 步骤 3：J 加入 ALL 群
**输入：**
```
/join ALL
```

**客户端预期输出：**
```
[DEBUG] Joining session: [ALL]
[Client] 正在加入会话: ALL
J [ALL]:
[系统] 已加入会话 ALL
```

**服务器预期输出：**
```
[SYS] J trying to join session: ALL
[SYS] J joined session ALL
```

### 步骤 4：J 发送消息
**输入：**
```
hello everyone
```

**客户端预期输出：**
```
[J] hello everyone
```

**服务器预期输出：**
```
[MSG] J -> ALL: hello everyone
```

### 步骤 5：启动客户端 Q 并加入
```bash
Client.exe
请输入昵称: Q
Q [未加入]: /join ALL
```

**Q 客户端预期输出：**
```
[DEBUG] Joining session: [ALL]
[Client] 正在加入会话: ALL
Q [ALL]:
[系统] 已加入会话 ALL
```

**J 客户端预期输出（收到通知）：**
```
[系统] Q 加入了会话
```

### 步骤 6：Q 发送消息
**Q 输入：**
```
Hi J
```

**Q 看到：**
```
[Q] Hi J
```

**J 看到：**
```
[Q] Hi J
```

---

## 📋 测试场景 2：私聊

### 步骤 1：Q 加入与 J 的私聊
**Q 输入：**
```
/join J
```

**Q 客户端预期输出：**
```
[DEBUG] Joining session: [J]
[Client] 正在加入会话: J
Q [J]:
[系统] 已加入会话 J
```

**服务器输出：**
```
[SYS] Q trying to join session: J
[SYS] Auto-created private session: J
[SYS] Q joined session J
```

**J 客户端预期输出（收到通知）：**
```
[系统] Q 加入了会话
```

### 步骤 2：Q 发送私聊消息
**Q 输入：**
```
Hi J, this is private
```

**Q 看到：**
```
[Q] Hi J, this is private
```

**J 看到（在 ALL 会话中）：**
```
[新消息 @Q] Q: Hi J, this is private
```

### 步骤 3：J 切换到私聊并回复
**J 输入：**
```
/switch Q
```

**J 预期输出：**
```
[Client] 已切换到会话: Q
--- 最近消息 ---
[Q] Hi J, this is private
---------------
J [Q]:
```

**J 输入：**
```
/join Q
```

**J 预期输出：**
```
[系统] 已加入会话 Q
```

**J 输入：**
```
Hi Q, I got your message
```

**J 看到：**
```
[J] Hi Q, I got your message
```

**Q 看到：**
```
[J] Hi Q, I got your message
```

---

## 📋 测试场景 3：查看会话列表

**Q 输入：**
```
/sessions
```

**预期输出：**
```
=== 我的会话列表 ===
ALL [群聊] - 2 条消息
J [私聊] - 2 条消息 [当前]
===================
```

---

## 🐛 常见问题排查

### 问题 1：`/join ALL` 不工作

**检查：**
1. 输入时是否有多余空格？试试：`/join ALL`（没有前后空格）
2. 服务器是否输出：`[SYS] J trying to join session: ALL`？
3. 如果服务器输出会话名带空格，说明解析有问题

**调试输出：**
- 客户端会显示：`[DEBUG] Joining session: [ALL]`
- 检查方括号内是否有多余空格

### 问题 2：私聊 session 不存在

**检查：**
1. 对方是否在线？
2. 服务器是否输出：`[SYS] Auto-created private session: J`？
3. 如果输出 `[WARN] User J not online`，说明对方不在线

### 问题 3：消息发不出去

**检查：**
1. 是否已加入该会话？
2. 提示符是否显示 `[未加入]`？
3. 如果是，先 `/join <会话名>`

---

## ✅ 成功标志

当你看到以下流程顺利完成：

1. ✅ `/join ALL` → 服务器输出 `[SYS] J joined session ALL`
2. ✅ 发送消息 → 服务器输出 `[MSG] J -> ALL: xxx`
3. ✅ 另一用户收到消息
4. ✅ `/join <用户名>` → 服务器自动创建私聊 session
5. ✅ 私聊消息正常收发

说明系统工作正常！

---

## 🔍 调试命令

如果还有问题，在客户端尝试：

```
/sessions        # 查看所有会话
/switch ALL      # 切换到 ALL 群
/join ALL        # 重新加入 ALL 群
```

在服务器端观察输出，看哪一步失败了。
